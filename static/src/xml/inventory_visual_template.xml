<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    
    <!-- Template principal del componente -->
    <t t-name="inventory_visual_enhanced.MainView" owl="1">
        <div class="o_inventory_visual_container d-flex flex-column vh-100" t-ref="root">
            
            <!-- Barra de búsqueda superior (sticky) -->
            <div class="o_inventory_visual_searchbar flex-shrink-0 sticky-top">
                <div class="searchbar-inner container d-flex align-items-center justify-content-between gap-2">
                    
                    <!-- Wrapper centrado con Bootstrap -->
                    <div class="searchbar-input-wrapper mx-auto col-12 col-md-8 col-lg-6 px-0 position-relative">
                        <i class="fa fa-search search-icon"></i>
                        <input 
                            type="text"
                            class="form-control"
                            placeholder="Buscar por producto, código o familia (ej: Tajmahal)..."
                            t-model="state.searchTerm"
                            t-on-input="onSearchInput"
                            t-att-disabled="state.isLoading"
                        />
                        <button 
                            class="clear-search btn btn-link p-0"
                            t-att-class="{ visible: state.searchTerm.length > 0 }"
                            t-on-click="clearSearch"
                        >
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    
                    <!-- Métrica a la derecha -->
                    <div class="searchbar-info text-nowrap ms-auto" t-if="state.hasSearched">
                        <span class="count" t-esc="state.totalProducts"></span>
                        <span t-if="state.totalProducts === 1"> producto</span>
                        <span t-else=""> productos</span>
                    </div>
                </div>
            </div>
            
            <!-- Contenido principal con scroll -->
            <div class="o_inventory_visual_content flex-grow-1 overflow-auto">
                
                <!-- Estado inicial: sin búsqueda -->
                <div class="o_inventory_visual_empty" t-if="!state.hasSearched and !state.isLoading">
                    <i class="fa fa-search empty-icon"></i>
                    <h2 class="empty-title">Busca para visualizar tu inventario</h2>
                    <p class="empty-subtitle">
                        Escribe el nombre de un producto, código o familia en el buscador superior
                        para ver el inventario agrupado con métricas detalladas.
                    </p>
                </div>
                
                <!-- Loading -->
                <div class="o_inventory_loading" t-if="state.isLoading">
                    <div class="spinner"></div>
                    <div class="loading-text">Cargando inventario...</div>
                </div>
                
                <!-- Error -->
                <div class="o_inventory_error" t-if="state.error">
                    <i class="fa fa-exclamation-triangle error-icon"></i>
                    <div class="error-message" t-esc="state.error"></div>
                </div>
                
                <!-- Sin resultados -->
                <div class="o_inventory_no_results" t-if="state.hasSearched and state.products.length === 0 and !state.isLoading">
                    <i class="fa fa-inbox no-results-icon"></i>
                    <h3 class="no-results-title">No se encontraron productos</h3>
                    <p class="no-results-message">
                        Intenta con otro término de búsqueda o verifica el inventario disponible.
                    </p>
                </div>
                
                <!-- DATA GRID - Lista de productos -->
                <div class="o_inventory_data_grid" t-if="state.products.length > 0 and !state.isLoading">
                    <table class="o_inventory_grid_table">
                        <thead>
                            <tr>
                                <th class="col-product-name">Product Name (SKU)</th>
                                <th class="col-inventory">Inventory</th>
                                <th class="col-type">Type</th>
                                <th class="col-category">Category</th>
                                <th class="col-format">Format</th>
                                <th class="col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="state.products" t-as="product" t-key="product.product_id">
                                <t t-call="inventory_visual_enhanced.ProductRow">
                                    <t t-set="product" t-value="product"/>
                                </t>
                            </t>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </t>
    
    <!-- Template de fila de producto - DATA GRID STYLE -->
    <t t-name="inventory_visual_enhanced.ProductRow" owl="1">
        <tr class="o_inventory_product_row" t-att-class="{ expanded: isProductExpanded(product.product_id) }">
            
            <!-- Columna 1: Product Name (SKU) -->
            <td class="col-product-name">
                <div class="product-name-cell">
                    <div class="product-title" t-esc="product.product_name"></div>
                    <div class="product-sku" t-if="product.product_code" t-esc="product.product_code"></div>
                </div>
            </td>
            
            <!-- Columna 2: Inventory (Sub-grid 4x2) -->
            <td class="col-inventory">
                <div class="inventory-subgrid">
                    <!-- Fila 1: In Stock -->
                    <div class="inventory-row">
                        <span class="inventory-label">In Stock</span>
                        <span class="inventory-value inventory-units" t-esc="product.stock_plates || 0"></span>
                        <span class="inventory-value inventory-measure">
                            <t t-esc="formatNumber(product.stock_qty)"/> M²
                        </span>
                    </div>
                    <!-- Fila 2: On Hold -->
                    <div class="inventory-row">
                        <span class="inventory-label">On Hold</span>
                        <span class="inventory-value inventory-units" t-esc="product.hold_plates || 0"></span>
                        <span class="inventory-value inventory-measure">
                            <t t-esc="formatNumber(product.hold_qty)"/> M²
                        </span>
                    </div>
                    <!-- Fila 3: Committed (NUEVA) -->
                    <div class="inventory-row">
                        <span class="inventory-label">Committed</span>
                        <span class="inventory-value inventory-units" t-esc="product.committed_plates || 0"></span>
                        <span class="inventory-value inventory-measure">
                            <t t-esc="formatNumber(product.committed_qty)"/> M²
                        </span>
                    </div>
                    <!-- Fila 4: Available -->
                    <div class="inventory-row">
                        <span class="inventory-label">Available</span>
                        <span class="inventory-value inventory-units" t-esc="product.available_plates || 0"></span>
                        <span class="inventory-value inventory-measure">
                            <t t-esc="formatNumber(product.available_qty)"/> M²
                        </span>
                    </div>
                </div>
            </td>
            
            <!-- Columna 3: Type -->
            <td class="col-type">
                <span t-if="product.formato">
                    <t t-if="product.formato.includes('Placa')">Placa</t>
                    <t t-else="" t-esc="product.formato"/>
                </span>
                <span t-else="" class="text-muted">-</span>
            </td>
            
            <!-- Columna 4: Category -->
            <td class="col-category">
                <span t-if="product.categ_name" t-esc="product.categ_name"/>
                <span t-else="" class="text-muted">-</span>
            </td>
            
            <!-- Columna 5: Format -->
            <td class="col-format">
                <span t-if="product.formato" t-esc="product.formato"/>
                <span t-else="" class="text-muted">-</span>
            </td>
            
            <!-- Columna 6: Actions -->
            <td class="col-actions">
                <button 
                    type="button" 
                    class="btn-expand-details"
                    t-on-click="() => this.toggleProduct(product.product_id, product.quant_ids)"
                >
                    <i class="fa fa-chevron-down" t-att-class="{ 'fa-chevron-up': isProductExpanded(product.product_id) }"></i>
                </button>
            </td>
        </tr>
        
        <!-- Fila expandible con detalles de placas -->
        <tr class="o_inventory_details_row" t-if="isProductExpanded(product.product_id)">
            <td colspan="6" class="details-cell">
                <t t-call="inventory_visual_enhanced.ProductDetails">
                    <t t-set="details" t-value="getProductDetails(product.product_id)"/>
                </t>
            </td>
        </tr>
    </t>
    
    <!-- Template de detalles del producto (tabla anidada) -->
    <t t-name="inventory_visual_enhanced.ProductDetails" owl="1">
        <t t-if="!details || details.length === 0">
            <div class="table-loading">
                <div class="spinner"></div>
                <div class="loading-text">Cargando placas...</div>
            </div>
        </t>
        <t t-else="">
            <div class="details-wrapper">
                <table class="o_inventory_details_table">
                    <thead>
                        <tr>
                            <th class="col-lot">Lote</th>
                            <th class="col-bloque">Bloque</th>
                            <th class="col-atado">Atado</th>
                            <th class="col-location">Ubicación</th>
                            <th class="col-dimensions">Dimensiones</th>
                            <th class="col-icon">P</th>
                            <th class="col-icon">N</th>
                            <th class="col-icon">D</th>
                            <th class="col-icon">SP</th>
                            <th class="col-icon">E</th>
                        </tr>
                    </thead>
                    <tbody>
                        <t t-foreach="details" t-as="detail" t-key="detail.id">
                            <tr>
                                <!-- 1. Lote -->
                                <td class="col-lot" data-label="Lote">
                                    <t t-if="detail.lot_name" t-esc="detail.lot_name"/>
                                    <span t-else="" class="text-muted">-</span>
                                </td>
                                
                                <!-- 2. Bloque -->
                                <td class="col-bloque" data-label="Bloque">
                                    <t t-if="detail.bloque" t-esc="detail.bloque"/>
                                    <span t-else="" class="text-muted">-</span>
                                </td>
                                
                                <!-- 3. Atado -->
                                <td class="col-atado" data-label="Atado">
                                    <t t-if="detail.atado" t-esc="detail.atado"/>
                                    <span t-else="" class="text-muted">-</span>
                                </td>
                                
                                <!-- 4. Ubicación -->
                                <td class="col-location" data-label="Ubicación">
                                    <i class="fa fa-map-marker"></i>
                                    <t t-esc="detail.location_name"/>
                                </td>
                                
                                <!-- 5. Dimensiones -->
                                <td class="col-dimensions" data-label="Dimensiones">
                                    <div class="dimensions-cell">
                                        <div class="dimensions-measures">
                                            <t t-if="detail.grosor or detail.alto or detail.ancho">
                                                <t t-if="detail.grosor">
                                                    <t t-esc="detail.grosor"/>cm × 
                                                </t>
                                                <t t-if="detail.alto">
                                                    <t t-esc="detail.alto"/>m × 
                                                </t>
                                                <t t-if="detail.ancho">
                                                    <t t-esc="detail.ancho"/>m
                                                </t>
                                            </t>
                                            <span t-else="" class="text-muted">-</span>
                                        </div>
                                        <div class="dimensions-total" t-if="detail.quantity">
                                            <t t-esc="formatNumber(detail.quantity)"/> m²
                                        </div>
                                    </div>
                                </td>
                                
                                <!-- 6. Fotos (P) - Dorado cuando hay contenido -->
                                <td class="col-icon" data-label="Foto">
                                    <button 
                                        class="icon-btn"
                                        t-att-class="detail.cantidad_fotos ? 'has-photos' : 'no-content'"
                                        t-on-click="() => this.onPhotoClick(detail.id)"
                                        type="button"
                                    >
                                        <i class="fa fa-camera"></i>
                                    </button>
                                </td>
                                
                                <!-- 7. Notas (N) - Rosa/Learning cuando hay contenido -->
                                <td class="col-icon" data-label="Notas">
                                    <button 
                                        class="icon-btn"
                                        t-att-class="detail.detalles_placa ? 'has-notes' : 'no-content'"
                                        t-on-click="() => this.onNotesClick(detail.id)"
                                        type="button"
                                    >
                                        <i class="fa fa-info-circle"></i>
                                    </button>
                                </td>
                                
                                <!-- 8. Detalles (D) - Morado siempre activo -->
                                <td class="col-icon" data-label="Detalles">
                                    <button 
                                        class="icon-btn has-details"
                                        t-on-click="() => this.onDetailsClick(detail.id)"
                                        type="button"
                                    >
                                        <i class="fa fa-list-alt"></i>
                                    </button>
                                </td>
                                
                                <!-- 9. Sales Person (SP) - Silver/Azul cuando hay contenido -->
                                <td class="col-icon" data-label="Cliente/Vendedor">
                                    <button 
                                        class="icon-btn"
                                        t-att-class="detail.sales_person ? 'has-sales-person' : 'no-content'"
                                        t-on-click="() => this.onSalesPersonClick(detail.id)"
                                        type="button"
                                    >
                                        <i class="fa fa-user"></i>
                                    </button>
                                </td>
                                
                                <!-- 10. Estado (E) - Hold o SO -->
                                <td class="col-icon" data-label="Estado">
                                    <div class="state-cell">
                                        <!-- Botón de Hold - Verde si activo, Dorado si disponible -->
                                        <button 
                                            class="icon-btn"
                                            t-if="!detail.en_orden_venta"
                                            t-att-class="detail.tiene_hold ? 'has-hold-active' : (detail.puede_hold ? 'has-hold-available' : 'no-content')"
                                            t-on-click="() => this.onHoldClick(detail.id, detail.hold_info)"
                                            type="button"
                                        >
                                            <i class="fa fa-hand-paper-o"></i>
                                        </button>
                                        
                                        <!-- Badge SO (Sale Order) - Verde cuando está en orden de venta -->
                                        <button 
                                            class="so-badge-btn"
                                            t-if="detail.en_orden_venta"
                                            t-on-click="() => this.onSaleOrderClick(detail.id, detail.sale_order_ids)"
                                            type="button"
                                        >
                                            <strong>SO</strong>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        </t>
                    </tbody>
                </table>
            </div>
        </t>
    </t>
    
</templates>