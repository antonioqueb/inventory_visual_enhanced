<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    
    <t t-name="inventory_visual_enhanced.SearchBar" owl="1">
        <div class="o_inventory_visual_searchbar flex-shrink-0 sticky-top" t-ref="root">
            <div class="searchbar-inner container">
                
                <!-- === HEADER MÓVIL === -->
                <div class="d-md-none mobile-header-row">
                    <div class="mobile-search-group">
                        <div class="mobile-icon-box">
                            <i class="fa fa-search"></i>
                        </div>
                        <input 
                            type="text"
                            class="mobile-input"
                            placeholder="Buscar producto..."
                            t-model="state.filters.product_name"
                            t-on-input="(ev) => this.onTextFilterChange('product_name', ev)"
                            t-att-disabled="props.isLoading"
                        />
                    </div>
                    
                    <button 
                        class="mobile-filter-btn" 
                        t-on-click="toggleMobileFilters"
                        t-att-class="{ 'active': state.mobileFiltersOpen, 'has-filters': hasActiveFilters() }"
                        type="button"
                    >
                        <i class="fa fa-filter"></i>
                    </button>
                </div>

                <!-- === CONTENEDOR DE FILTROS PRINCIPALES === -->
                <div class="filters-row main-filters" t-att-class="{ 'd-none': !state.mobileFiltersOpen, 'd-grid': state.mobileFiltersOpen, 'd-md-grid': true }">
                    
                    <!-- Búsqueda Desktop -->
                    <div class="filter-group search-product-name d-none d-md-flex">
                        <label class="filter-label">Buscar Producto</label>
                        <input 
                            type="text" 
                            class="form-control filter-input" 
                            placeholder="Nombre o código..." 
                            t-model="state.filters.product_name" 
                            t-on-input="(ev) => this.onTextFilterChange('product_name', ev)" 
                            t-att-disabled="props.isLoading"
                        />
                    </div>

                    <!-- Almacén -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Almacén</label>
                        <select 
                            class="form-select filter-select" 
                            t-model="state.filters.almacen_id" 
                            t-on-change="onAlmacenChange" 
                            t-att-disabled="props.isLoading"
                        >
                            <option value="">Todos los almacenes</option>
                            <t t-foreach="state.almacenes" t-as="almacen" t-key="almacen.id">
                                <option t-att-value="almacen.id" t-esc="almacen.name"></option>
                            </t>
                        </select>
                    </div>

                    <!-- Ubicación -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Ubicación</label>
                        <select 
                            class="form-select filter-select" 
                            t-model="state.filters.ubicacion_id" 
                            t-on-change="(ev) => this.onFilterChange('ubicacion_id', ev)" 
                            t-att-disabled="props.isLoading or !state.filters.almacen_id or state.ubicaciones.length === 0"
                        >
                            <option value="">Todas las ubicaciones</option>
                            <t t-foreach="state.ubicaciones" t-as="ubicacion" t-key="ubicacion.id">
                                <option t-att-value="ubicacion.id" t-esc="ubicacion.complete_name"></option>
                            </t>
                        </select>
                    </div>

                    <!-- Tipo -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Tipo</label>
                        <select 
                            class="form-select filter-select" 
                            t-model="state.filters.tipo" 
                            t-on-change="(ev) => this.onFilterChange('tipo', ev)" 
                            t-att-disabled="props.isLoading"
                        >
                            <option value="">Todos los tipos</option>
                            <t t-foreach="state.tipos" t-as="tipo" t-key="tipo_index">
                                <option t-att-value="tipo[0]" t-esc="tipo[1]"></option>
                            </t>
                        </select>
                    </div>

                    <!-- Categoría -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Categoría</label>
                        <input 
                            type="text" 
                            class="form-control filter-input" 
                            placeholder="Escribe categoría..." 
                            t-model="state.filters.categoria_name" 
                            t-on-input="(ev) => this.onTextFilterChange('categoria_name', ev)"
                            list="categorias-datalist"
                            autocomplete="off"
                            t-att-disabled="props.isLoading"
                        />
                        <datalist id="categorias-datalist">
                            <t t-foreach="state.categorias" t-as="categoria" t-key="categoria.name">
                                <option t-att-value="categoria.name"/>
                            </t>
                        </datalist>
                    </div>

                    <!-- Botones -->
                    <div class="filter-actions d-flex justify-content-between gap-2">
                        <button 
                            class="btn btn-sm btn-light border flex-grow-1" 
                            t-on-click="toggleAdvancedFilters" 
                            title="Filtros avanzados"
                        >
                            <i class="fa fa-sliders me-1"></i> 
                            <t t-if="!state.showAdvancedFilters">Más</t>
                            <t t-else="">Menos</t>
                        </button>
                        <button 
                            class="btn btn-sm btn-light border" 
                            t-on-click="clearAllFilters" 
                            t-att-disabled="!hasActiveFilters()" 
                            title="Limpiar"
                        >
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>

                <!-- === FILTROS AVANZADOS === -->
                <div class="filters-row advanced-filters mt-3" t-if="state.showAdvancedFilters" t-att-class="{ 'd-none': !state.mobileFiltersOpen, 'd-grid': state.mobileFiltersOpen, 'd-md-grid': true }">
                    
                    <!-- Grupo -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Grupo</label>
                        <input 
                            type="text" 
                            class="form-control filter-input" 
                            placeholder="Escribe grupo..." 
                            t-model="state.filters.grupo" 
                            t-on-input="(ev) => this.onTextFilterChange('grupo', ev)"
                            list="grupos-datalist"
                            autocomplete="off"
                        />
                        <datalist id="grupos-datalist">
                            <t t-foreach="state.grupos" t-as="grupo" t-key="grupo_index">
                                <option t-att-value="grupo[1]"/>
                            </t>
                        </datalist>
                    </div>


                    <!-- === MARCA === -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Marca</label>
                        <input 
                            type="text" 
                            class="form-control filter-input" 
                            placeholder="Buscar marca..." 
                            t-model="state.filters.marca" 
                            t-on-input="(ev) => this.onTextFilterChange('marca', ev)"
                            list="marcas-datalist"
                            autocomplete="off"
                        />
                        <datalist id="marcas-datalist">
                            <t t-foreach="state.marcas" t-as="marca" t-key="marca">
                                <option t-att-value="marca"/>
                            </t>
                        </datalist>
                    </div>

                    <!-- Color -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Color</label>
                        <input 
                            type="text" 
                            class="form-control filter-input" 
                            placeholder="Escribe o selecciona color..." 
                            t-model="state.filters.color" 
                            t-on-input="(ev) => this.onTextFilterChange('color', ev)"
                            list="colores-datalist"
                            autocomplete="off"
                        />
                        <datalist id="colores-datalist">
                            <t t-foreach="state.colores" t-as="color" t-key="color">
                                <option t-att-value="color"/>
                            </t>
                        </datalist>
                    </div>
       
                    
                    <!-- Espesor -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Espesor</label>
                        <select 
                            class="form-select filter-select" 
                            t-model="state.filters.grosor" 
                            t-on-change="(ev) => this.onFilterChange('grosor', ev)"
                        >
                            <option value="">Grosor...</option>
                            <t t-foreach="state.grosores" t-as="grosor" t-key="grosor">
                                <option t-att-value="grosor" t-esc="grosor + ' cm'"></option>
                            </t>
                        </select>
                    </div>
                    
                    <!-- Alto Mínimo -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Alto mín. (m)</label>
                        <input 
                            type="number" 
                            class="form-control filter-input" 
                            placeholder="Ej: 1.5" 
                            t-model="state.filters.alto_min" 
                            t-on-input="(ev) => this.onTextFilterChange('alto_min', ev)"
                            step="0.01"
                            min="0"
                        />
                    </div>

                    <!-- Ancho Mínimo -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Ancho mín. (m)</label>
                        <input 
                            type="number" 
                            class="form-control filter-input" 
                            placeholder="Ej: 2.0" 
                            t-model="state.filters.ancho_min" 
                            t-on-input="(ev) => this.onTextFilterChange('ancho_min', ev)"
                            step="0.01"
                            min="0"
                        />
                    </div>
                    
                    <!-- Lote -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Lote</label>
                        <input 
                            type="text" 
                            class="form-control filter-input" 
                            placeholder="Lotes separados por coma (ej: L1, L2)..." 
                            t-model="state.filters.numero_serie" 
                            t-on-input="(ev) => this.onTextFilterChange('numero_serie', ev)"
                        />
                    </div>
                    
                    <!-- Bloque -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Bloque</label>
                        <input 
                            type="text" 
                            class="form-control filter-input" 
                            placeholder="Bloque..." 
                            t-model="state.filters.bloque" 
                            t-on-input="(ev) => this.onTextFilterChange('bloque', ev)"
                        />
                    </div>
                    
                    <!-- Pedimento -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Pedimento</label>
                        <input 
                            type="text" 
                            class="form-control filter-input" 
                            placeholder="Pedimento..." 
                            t-model="state.filters.pedimento" 
                            t-on-input="(ev) => this.onTextFilterChange('pedimento', ev)"
                        />
                    </div>
                    
                    <!-- Contenedor -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Contenedor</label>
                        <input 
                            type="text" 
                            class="form-control filter-input" 
                            placeholder="Contenedor..." 
                            t-model="state.filters.contenedor" 
                            t-on-input="(ev) => this.onTextFilterChange('contenedor', ev)"
                        />
                    </div>
                    
                    <!-- Atado -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Atado</label>
                        <input 
                            type="text" 
                            class="form-control filter-input" 
                            placeholder="Atado..." 
                            t-model="state.filters.atado" 
                            t-on-input="(ev) => this.onTextFilterChange('atado', ev)"
                        />
                    </div>
                    
                    <!-- Color -->
                    <div class="filter-group">
                        <label class="filter-label d-none d-md-block">Color</label>
                        <input 
                            type="text" 
                            class="form-control filter-input" 
                            placeholder="Escribe o selecciona color..." 
                            t-model="state.filters.color" 
                            t-on-input="(ev) => this.onTextFilterChange('color', ev)"
                            list="colores-datalist"
                            autocomplete="off"
                        />
                        <datalist id="colores-datalist">
                            <t t-foreach="state.colores" t-as="color" t-key="color">
                                <option t-att-value="color"/>
                            </t>
                        </datalist>
                    </div>
                </div>

                <!-- === FILTRO DE PRECIOS === -->
                <div class="price-filter-row mt-3" t-if="state.showAdvancedFilters" t-att-class="{ 'd-none': !state.mobileFiltersOpen, 'd-flex': state.mobileFiltersOpen, 'd-md-flex': true }">
                    <div class="price-filter-container">
                        <div class="price-filter-label">
                            <i class="fa fa-dollar"></i>
                            <span>Precio</span>
                        </div>
                        <div class="price-filter-controls">
                            <select 
                                class="form-select filter-select price-select"
                                t-model="state.filters.price_currency"
                                t-on-change="(ev) => this.onPriceSettingChange('price_currency', ev)"
                            >
                                <option value="">Divisa...</option>
                                <option value="USD">USD</option>
                                <option value="MXN">MXN</option>
                            </select>
                            
                            <select 
                                class="form-select filter-select price-select"
                                t-model="state.filters.price_level"
                                t-on-change="(ev) => this.onPriceSettingChange('price_level', ev)"
                            >
                                <option value="">Nivel...</option>
                                <option value="high">Alto</option>
                                <option value="medium">Medio</option>
                            </select>
                            
                            <div class="price-range-input">
                                <span class="price-range-prefix">Min</span>
                                <input 
                                    type="number" 
                                    class="form-control filter-input"
                                    placeholder="0.00"
                                    t-model="state.filters.price_min"
                                    t-on-input="(ev) => this.onPriceValueChange('price_min', ev)"
                                    step="0.01"
                                    min="0"
                                />
                            </div>
                            
                            <span class="price-range-separator">—</span>
                            
                            <div class="price-range-input">
                                <span class="price-range-prefix">Max</span>
                                <input 
                                    type="number" 
                                    class="form-control filter-input"
                                    placeholder="999..."
                                    t-model="state.filters.price_max"
                                    t-on-input="(ev) => this.onPriceValueChange('price_max', ev)"
                                    step="0.01"
                                    min="0"
                                />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Info Resultados -->
                <div class="filters-info mt-2 py-1" t-if="props.hasSearched">
                    <span class="results-count small">
                        <strong t-esc="props.totalProducts"></strong> <span> prod.</span>
                    </span>
                </div>
            </div>
        </div>
    </t>
    
</templates>