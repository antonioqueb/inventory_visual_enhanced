<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    
    <t t-name="inventory_visual_enhanced.InventoryView" owl="1">
        <div class="o_inventory_visual_container d-flex flex-column vh-100" t-ref="root">
            
            <!-- Barra de filtros superior -->
            <div class="o_inventory_visual_searchbar flex-shrink-0 sticky-top" t-att-class="{ 'mobile-open': state.mobileFiltersOpen }">
                <div class="searchbar-inner container">
                    
                    <!-- CABECERA MÓVIL / BARRA PRINCIPAL -->
                    <div class="search-header-row">
                        <!-- Búsqueda por nombre (Siempre visible) -->
                        <div class="filter-group search-product-name flex-grow-1">
                            <div class="input-group">
                                <span class="input-group-text bg-white border-end-0 text-muted">
                                    <i class="fa fa-search"></i>
                                </span>
                                <input 
                                    type="text"
                                    class="form-control filter-input border-start-0 ps-0"
                                    placeholder="Buscar producto (Nombre, Código)..."
                                    t-model="state.filters.product_name"
                                    t-on-input="(ev) => this.onTextFilterChange('product_name', ev)"
                                    t-att-disabled="state.isLoading"
                                />
                            </div>
                        </div>

                        <!-- Botón Toggle Filtros (Solo visible en móvil) -->
                        <button 
                            class="btn btn-light border btn-mobile-toggle d-md-none ms-2"
                            t-on-click="toggleMobileFilters"
                            t-att-class="{ 'active': state.mobileFiltersOpen }"
                        >
                            <i class="fa fa-filter"></i>
                            <span class="notification-dot" t-if="hasActiveFilters()"></span>
                        </button>
                    </div>

                    <!-- CONTENEDOR COLAPSABLE (Filtros secundarios) -->
                    <div class="secondary-filters-container">
                        <div class="filters-row main-filters mt-md-0">
                            
                            <!-- Almacén -->
                            <div class="filter-group">
                                <label class="filter-label d-none d-md-block">Almacén</label>
                                <select 
                                    class="form-select filter-select"
                                    t-model="state.filters.almacen_id"
                                    t-on-change="onAlmacenChange"
                                    t-att-disabled="state.isLoading"
                                >
                                    <option value="">Todos los almacenes</option>
                                    <t t-foreach="state.almacenes" t-as="almacen" t-key="almacen.id">
                                        <option t-att-value="almacen.id" t-esc="almacen.name"></option>
                                    </t>
                                </select>
                            </div>

                            <!-- Ubicación -->
                            <div class="filter-group">
                                <label class="filter-label d-none d-md-block">Ubicación</label>
                                <select 
                                    class="form-select filter-select"
                                    t-model="state.filters.ubicacion_id"
                                    t-on-change="(ev) => this.onFilterChange('ubicacion_id', ev)"
                                    t-att-disabled="state.isLoading or !state.filters.almacen_id or state.ubicaciones.length === 0"
                                >
                                    <option value="">Todas las ubicaciones</option>
                                    <t t-foreach="state.ubicaciones" t-as="ubicacion" t-key="ubicacion.id">
                                        <option t-att-value="ubicacion.id" t-esc="ubicacion.complete_name"></option>
                                    </t>
                                </select>
                            </div>

                            <!-- Tipo -->
                            <div class="filter-group">
                                <label class="filter-label d-none d-md-block">Tipo</label>
                                <select 
                                    class="form-select filter-select"
                                    t-model="state.filters.tipo"
                                    t-on-change="(ev) => this.onFilterChange('tipo', ev)"
                                    t-att-disabled="state.isLoading"
                                >
                                    <option value="">Todos los tipos</option>
                                    <t t-foreach="state.tipos" t-as="tipo" t-key="tipo_index">
                                        <option t-att-value="tipo[0]" t-esc="tipo[1]"></option>
                                    </t>
                                </select>
                            </div>

                            <!-- Categoría -->
                            <div class="filter-group">
                                <label class="filter-label d-none d-md-block">Categoría</label>
                                <select 
                                    class="form-select filter-select"
                                    t-model="state.filters.categoria_id"
                                    t-on-change="(ev) => this.onFilterChange('categoria_id', ev)"
                                    t-att-disabled="state.isLoading"
                                >
                                    <option value="">Todas las categorías</option>
                                    <t t-foreach="state.categorias" t-as="categoria" t-key="categoria.id">
                                        <option t-att-value="categoria.id" t-esc="categoria.complete_name"></option>
                                    </t>
                                </select>
                            </div>

                            <!-- Botones de acción -->
                            <div class="filter-actions">
                                <button 
                                    class="btn btn-sm btn-light border w-100"
                                    t-on-click="toggleAdvancedFilters"
                                    title="Filtros avanzados"
                                >
                                    <i class="fa fa-sliders me-1"></i>
                                    <t t-if="!state.showAdvancedFilters">Más</t>
                                    <t t-else="">Menos</t>
                                </button>
                                <button 
                                    class="btn btn-sm btn-light border w-100"
                                    t-on-click="clearAllFilters"
                                    t-att-disabled="!hasActiveFilters()"
                                    title="Limpiar todos los filtros"
                                >
                                    <i class="fa fa-times"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Filtros avanzados (desplegables) -->
                        <div class="filters-row advanced-filters mt-2" t-if="state.showAdvancedFilters">
                            <!-- Grupo -->
                            <div class="filter-group">
                                <select 
                                    class="form-select filter-select"
                                    t-model="state.filters.grupo"
                                    t-on-change="(ev) => this.onFilterChange('grupo', ev)"
                                    t-att-disabled="state.isLoading"
                                >
                                    <option value="">Grupo...</option>
                                    <t t-foreach="state.grupos" t-as="grupo" t-key="grupo_index">
                                        <option t-att-value="grupo[0]" t-esc="grupo[1]"></option>
                                    </t>
                                </select>
                            </div>

                            <!-- Acabado -->
                            <div class="filter-group">
                                <select 
                                    class="form-select filter-select"
                                    t-model="state.filters.acabado"
                                    t-on-change="(ev) => this.onFilterChange('acabado', ev)"
                                    t-att-disabled="state.isLoading"
                                >
                                    <option value="">Acabado...</option>
                                    <t t-foreach="state.acabados" t-as="acabado" t-key="acabado_index">
                                        <option t-att-value="acabado[0]" t-esc="acabado[1]"></option>
                                    </t>
                                </select>
                            </div>

                            <!-- Grosor -->
                            <div class="filter-group">
                                <select 
                                    class="form-select filter-select"
                                    t-model="state.filters.grosor"
                                    t-on-change="(ev) => this.onFilterChange('grosor', ev)"
                                    t-att-disabled="state.isLoading"
                                >
                                    <option value="">Grosor...</option>
                                    <t t-foreach="state.grosores" t-as="grosor" t-key="grosor">
                                        <option t-att-value="grosor" t-esc="grosor + ' cm'"></option>
                                    </t>
                                </select>
                            </div>

                            <!-- Número de serie -->
                            <div class="filter-group">
                                <input 
                                    type="text"
                                    class="form-control filter-input"
                                    placeholder="N° Serie"
                                    t-model="state.filters.numero_serie"
                                    t-on-input="(ev) => this.onTextFilterChange('numero_serie', ev)"
                                    t-att-disabled="state.isLoading"
                                />
                            </div>

                            <!-- Bloque -->
                            <div class="filter-group">
                                <input 
                                    type="text"
                                    class="form-control filter-input"
                                    placeholder="Bloque"
                                    t-model="state.filters.bloque"
                                    t-on-input="(ev) => this.onTextFilterChange('bloque', ev)"
                                    t-att-disabled="state.isLoading"
                                />
                            </div>

                            <!-- Pedimento -->
                            <div class="filter-group">
                                <input 
                                    type="text"
                                    class="form-control filter-input"
                                    placeholder="Pedimento"
                                    t-model="state.filters.pedimento"
                                    t-on-input="(ev) => this.onTextFilterChange('pedimento', ev)"
                                    t-att-disabled="state.isLoading"
                                />
                            </div>

                            <!-- Contenedor -->
                            <div class="filter-group">
                                <input 
                                    type="text"
                                    class="form-control filter-input"
                                    placeholder="Contenedor"
                                    t-model="state.filters.contenedor"
                                    t-on-input="(ev) => this.onTextFilterChange('contenedor', ev)"
                                    t-att-disabled="state.isLoading"
                                />
                            </div>

                            <!-- Atado -->
                            <div class="filter-group">
                                <input 
                                    type="text"
                                    class="form-control filter-input"
                                    placeholder="Atado"
                                    t-model="state.filters.atado"
                                    t-on-input="(ev) => this.onTextFilterChange('atado', ev)"
                                    t-att-disabled="state.isLoading"
                                />
                            </div>
                        </div>

                        <!-- Información de resultados -->
                        <div class="filters-info mt-2" t-if="state.hasSearched">
                            <span class="results-count">
                                <strong t-esc="state.totalProducts"></strong>
                                <span t-if="state.totalProducts === 1"> producto encontrado</span>
                                <span t-else=""> productos encontrados</span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Contenido principal -->
            <div class="o_inventory_visual_content flex-grow-1 overflow-auto">
                
                <!-- Estado inicial -->
                <div class="o_inventory_visual_empty" t-if="!state.hasSearched and !state.isLoading">
                    <i class="fa fa-filter empty-icon"></i>
                    <h2 class="empty-title">Aplica filtros para visualizar tu inventario</h2>
                    <p class="empty-subtitle">
                        Selecciona uno o más filtros en la barra superior
                        para ver el inventario agrupado con métricas detalladas.
                    </p>
                </div>
                
                <!-- Loading -->
                <div class="o_inventory_loading" t-if="state.isLoading">
                    <div class="spinner"></div>
                    <div class="loading-text">Cargando inventario...</div>
                </div>
                
                <!-- Error -->
                <div class="o_inventory_error" t-if="state.error">
                    <i class="fa fa-exclamation-triangle error-icon"></i>
                    <div class="error-message" t-esc="state.error"></div>
                </div>
                
                <!-- Sin resultados -->
                <div class="o_inventory_no_results" t-if="state.hasSearched and state.products.length === 0 and !state.isLoading">
                    <i class="fa fa-inbox no-results-icon"></i>
                    <h3 class="no-results-title">No se encontraron productos</h3>
                    <p class="no-results-message">
                        Intenta con otros filtros o verifica el inventario disponible.
                    </p>
                </div>
                
                <!-- DATA GRID -->
                <div class="o_inventory_data_grid" t-if="state.products.length > 0 and !state.isLoading">
                    <table class="o_inventory_grid_table">
                        <thead>
                            <tr>
                                <th class="col-product-name">Product Name (SKU)</th>
                                <th class="col-inventory">Inventory</th>
                                <th class="col-type">Type</th>
                                <th class="col-category">Category</th>
                                <th class="col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-foreach="state.products" t-as="product" t-key="product.product_id">
                                <ProductRow 
                                    product="product"
                                    isExpanded="isProductExpanded(product.product_id)"
                                    details="getProductDetails(product.product_id)"
                                    onToggle.bind="(quantIds) => this.toggleProduct(product.product_id, quantIds)"
                                    onPhotoClick.bind="onPhotoClick"
                                    onNotesClick.bind="onNotesClick"
                                    onDetailsClick.bind="onDetailsClick"
                                    onSalesPersonClick.bind="onSalesPersonClick"
                                    onHoldClick.bind="onHoldClick"
                                    onSaleOrderClick.bind="onSaleOrderClick"
                                    formatNumber.bind="formatNumber"
                                    hasSalesPermissions="state.hasSalesPermissions"
                                    hasInventoryPermissions="state.hasInventoryPermissions"
                                    isInCart.bind="isInCart"
                                    toggleCartSelection.bind="toggleCartSelection"
                                    areAllCurrentProductSelected.bind="() => this.areAllCurrentProductSelected()"
                                    selectAllCurrentProduct.bind="() => this.selectAllCurrentProduct()"
                                    deselectAllCurrentProduct.bind="() => this.deselectAllCurrentProduct()"
                                />
                            </t>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </t>
    
</templates>