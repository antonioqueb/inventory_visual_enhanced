<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    
    <t t-name="inventory_visual_enhanced.ProductRow" owl="1">
        <!-- El evento click principal expande/contrae (toggle normal) -->
        <tr class="o_inventory_product_row" 
            t-att-class="{ expanded: props.isExpanded }"
            t-on-click="() => props.onToggle(props.product.quant_ids)"
            title="Click para ver detalles"
        >
            
            <!-- Product Name -->
            <td class="col-product-name">
                <div class="product-name-cell">
                    <div class="product-title" t-esc="props.product.product_name"></div>
                    <div class="product-sku" t-if="props.product.product_code" t-esc="props.product.product_code"></div>
                </div>
            </td>
            
            <!-- Inventory: AHORA CON FILTROS CLICKABLES + SECCIÓN TRÁNSITO -->
            <td class="col-inventory">
                <div class="inventory-subgrid">
                    
                    <!-- === SECCIÓN STOCK (Interno) === -->
                    
                    <!-- IN STOCK (ALL) -->
                    <div class="inventory-row clickable-stat" 
                         t-att-class="{ 'active-filter': state.activeFilter === 'all' }"
                         t-on-click.stop="() => this.handleFilterClick('all')"
                         title="Ver todo el inventario en almacén">
                        <span class="inventory-label">In Stock</span>
                        <span class="inventory-value inventory-units" t-esc="props.product.stock_plates || 0"></span>
                        <span class="inventory-value inventory-measure">
                            <t t-esc="props.formatNumber(props.product.stock_qty)"/> M²
                        </span>
                    </div>

                    <!-- ON HOLD -->
                    <div class="inventory-row clickable-stat"
                         t-att-class="{ 'active-filter': state.activeFilter === 'hold' }" 
                         t-on-click.stop="() => this.handleFilterClick('hold')"
                         title="Filtrar apartados en almacén">
                        <span class="inventory-label">On Hold</span>
                        <span class="inventory-value inventory-units" t-esc="props.product.hold_plates || 0"></span>
                        <span class="inventory-value inventory-measure">
                            <t t-esc="props.formatNumber(props.product.hold_qty)"/> M²
                        </span>
                    </div>

                    <!-- COMMITTED -->
                    <div class="inventory-row clickable-stat"
                         t-att-class="{ 'active-filter': state.activeFilter === 'committed' }" 
                         t-on-click.stop="() => this.handleFilterClick('committed')"
                         title="Filtrar comprometido en almacén">
                        <span class="inventory-label">Committed</span>
                        <span class="inventory-value inventory-units" t-esc="props.product.committed_plates || 0"></span>
                        <span class="inventory-value inventory-measure">
                            <t t-esc="props.formatNumber(props.product.committed_qty)"/> M²
                        </span>
                    </div>

                    <!-- AVAILABLE -->
                    <div class="inventory-row clickable-stat"
                         t-att-class="{ 'active-filter': state.activeFilter === 'available' }" 
                         t-on-click.stop="() => this.handleFilterClick('available')"
                         title="Filtrar disponible para venta en almacén">
                        <span class="inventory-label text-success">Disponible</span>
                        <span class="inventory-value inventory-units" t-esc="props.product.available_plates || 0"></span>
                        <span class="inventory-value inventory-measure text-success">
                            <t t-esc="props.formatNumber(props.product.available_qty)"/> M²
                        </span>
                    </div>

                    <!-- === SECCIÓN TRÁNSITO (Si hay algo en tránsito) === -->
                    <t t-if="props.product.transit_qty > 0">
                        <div class="inventory-separator">
                            <span>En Tránsito</span>
                        </div>

                        <!-- TRANSIT AVAILABLE -->
                        <div class="inventory-row clickable-stat transit-row"
                             t-att-class="{ 'active-filter': state.activeFilter === 'transit_available' }" 
                             t-on-click.stop="() => this.handleFilterClick('transit_available')"
                             title="Disponible en Tránsito">
                            <span class="inventory-label">T. Available</span>
                            <span class="inventory-value inventory-units" t-esc="props.product.transit_available_plates || 0"></span>
                            <span class="inventory-value inventory-measure">
                                <t t-esc="props.formatNumber(props.product.transit_available_qty)"/> M²
                            </span>
                        </div>

                        <!-- TRANSIT HOLD -->
                        <div class="inventory-row clickable-stat transit-row"
                             t-att-class="{ 'active-filter': state.activeFilter === 'transit_hold' }" 
                             t-on-click.stop="() => this.handleFilterClick('transit_hold')"
                             title="Apartado en Tránsito">
                            <span class="inventory-label">T. On Hold</span>
                            <span class="inventory-value inventory-units" t-esc="props.product.transit_hold_plates || 0"></span>
                            <span class="inventory-value inventory-measure">
                                <t t-esc="props.formatNumber(props.product.transit_hold_qty)"/> M²
                            </span>
                        </div>

                        <!-- TRANSIT COMMITTED -->
                        <div class="inventory-row clickable-stat transit-row"
                             t-att-class="{ 'active-filter': state.activeFilter === 'transit_committed' }" 
                             t-on-click.stop="() => this.handleFilterClick('transit_committed')"
                             title="Comprometido en Tránsito">
                            <span class="inventory-label">T. Committed</span>
                            <span class="inventory-value inventory-units" t-esc="props.product.transit_committed_plates || 0"></span>
                            <span class="inventory-value inventory-measure">
                                <t t-esc="props.formatNumber(props.product.transit_committed_qty)"/> M²
                            </span>
                        </div>
                    </t>

                </div>
            </td>
            
            <!-- Type -->
            <td class="col-type">
                <span t-if="props.product.tipo" t-esc="props.product.tipo"/>
                <span t-else="" class="text-muted">-</span>
            </td>
            
            <!-- Category -->
            <td class="col-category">
                <span t-if="props.product.categ_name" t-esc="shortCategoryName"/>
                <span t-else="" class="text-muted">-</span>
            </td>
        </tr>
        
        <!-- Fila de detalles -->
        <tr class="o_inventory_details_row" t-if="props.isExpanded">
            <td colspan="4" class="details-cell">
                <!-- Pasamos 'filteredDetails' y las nuevas props de cantidad manual -->
                <ProductDetails 
                    details="filteredDetails"
                    onPhotoClick="props.onPhotoClick"
                    onNotesClick="props.onNotesClick"
                    onDetailsClick="props.onDetailsClick"
                    onSalesPersonClick="props.onSalesPersonClick"
                    onHoldClick="props.onHoldClick"
                    onSaleOrderClick="props.onSaleOrderClick"
                    formatNumber="props.formatNumber"
                    isInCart="props.isInCart"
                    
                    getDisplayQuantity="props.getDisplayQuantity"
                    toggleCartSelection="props.toggleCartSelection"
                    onInputManualQuantity="props.onInputManualQuantity"
                    
                    areAllCurrentProductSelected="props.areAllCurrentProductSelected"
                    selectAllCurrentProduct="props.selectAllCurrentProduct"
                    deselectAllCurrentProduct="props.deselectAllCurrentProduct"
                    hasSalesPermissions="props.hasSalesPermissions"
                    hasInventoryPermissions="props.hasInventoryPermissions"
                />
            </td>
        </tr>
    </t>
    
</templates>