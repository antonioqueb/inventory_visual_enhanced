<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    
    <t t-name="inventory_visual_enhanced.ProductRow" owl="1">
        <tr class="o_inventory_product_row" 
            t-att-class="{ expanded: props.isExpanded }"
            t-on-click="() => props.onToggle(props.product.quant_ids)"
            title="Click para ver detalles"
        >
            
            <!-- Product Name + Price Tooltip -->
            <td class="col-product-name">
                <div class="product-name-cell">
                    <div class="d-flex align-items-center gap-1">
                        <div class="product-title" t-esc="props.product.product_name"></div>
                        
                        <!-- Icono ? con tooltip de precios -->
                        <div class="price-tooltip-wrapper" 
                             t-on-click.stop="() => {}"
                             t-on-mouseenter="onPriceMouseEnter"
                             t-on-mouseleave="onPriceMouseLeave"
                             style="position: relative; display: inline-flex;">
                            
                            <span class="price-help-icon" 
                                  style="cursor: help; color: #714B67; font-size: 13px; font-weight: 700; 
                                         width: 18px; height: 18px; border-radius: 50%; border: 1.5px solid #714B67;
                                         display: inline-flex; align-items: center; justify-content: center;
                                         line-height: 1; flex-shrink: 0;">?</span>
                            
                            <!-- Tooltip flotante -->
                            <div t-if="state.showPriceTooltip" 
                                 class="price-tooltip-popup"
                                 style="position: absolute; top: 100%; left: 0; z-index: 9999; margin-top: 6px;
                                        background: #fff; border: 1px solid #dee2e6; border-radius: 8px;
                                        box-shadow: 0 4px 16px rgba(0,0,0,0.15); padding: 12px 16px;
                                        min-width: 280px; white-space: nowrap;">
                                
                                <!-- Flecha -->
                                <div style="position: absolute; top: -6px; left: 14px; width: 12px; height: 12px;
                                            background: #fff; border-left: 1px solid #dee2e6; border-top: 1px solid #dee2e6;
                                            transform: rotate(45deg);"></div>
                                
                                <!-- Loading -->
                                <div t-if="state.priceLoading" class="text-center py-2">
                                    <i class="fa fa-spinner fa-spin me-2"></i>
                                    <span class="text-muted">Cargando precios...</span>
                                </div>
                                
                                <!-- Sin datos -->
                                <div t-elif="!state.priceData" class="text-center py-2">
                                    <span class="text-muted">Sin información de precios</span>
                                </div>
                                
                                <!-- Datos de precios -->
                                <div t-else="">
                                    <div style="font-weight: 700; font-size: 13px; color: #714B67; 
                                                margin-bottom: 8px; border-bottom: 2px solid #714B67; 
                                                padding-bottom: 4px;">
                                        Precios de Referencia
                                    </div>
                                    
                                    <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                                        <thead>
                                            <tr style="border-bottom: 1px solid #eee;">
                                                <th style="padding: 3px 6px; text-align: left; color: #666;"></th>
                                                <th style="padding: 3px 6px; text-align: right; color: #017E84; font-weight: 700;">USD</th>
                                                <th style="padding: 3px 6px; text-align: right; color: #714B67; font-weight: 700;">MXN</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr style="border-bottom: 1px solid #f5f5f5;">
                                                <td style="padding: 4px 6px; font-weight: 600;">
                                                    <span style="color: #28a745;">●</span> Alto
                                                </td>
                                                <td style="padding: 4px 6px; text-align: right; font-family: monospace;">
                                                    $<t t-esc="formatPrice(state.priceData.usd_high)"/>
                                                </td>
                                                <td style="padding: 4px 6px; text-align: right; font-family: monospace;">
                                                    $<t t-esc="formatPrice(state.priceData.mxn_high)"/>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td style="padding: 4px 6px; font-weight: 600;">
                                                    <span style="color: #ffc107;">●</span> Medio
                                                </td>
                                                <td style="padding: 4px 6px; text-align: right; font-family: monospace;">
                                                    $<t t-esc="formatPrice(state.priceData.usd_medium)"/>
                                                </td>
                                                <td style="padding: 4px 6px; text-align: right; font-family: monospace;">
                                                    $<t t-esc="formatPrice(state.priceData.mxn_medium)"/>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="product-sku" t-if="props.product.product_code" t-esc="props.product.product_code"></div>
                </div>
            </td>
            
            <!-- Inventory -->
            <td class="col-inventory">
                <div class="inventory-subgrid">
                    
                    <div class="inventory-row clickable-stat" 
                         t-att-class="{ 'active-filter': state.activeFilter === 'all' }"
                         t-on-click.stop="() => this.handleFilterClick('all')"
                         title="Ver todo el inventario en almacén">
                        <span class="inventory-label">In Stock</span>
                        <span class="inventory-value inventory-units" t-esc="props.product.stock_plates || 0"></span>
                        <span class="inventory-value inventory-measure">
                            <t t-esc="props.formatNumber(props.product.stock_qty)"/> <t t-esc="unitLabel"/>
                        </span>
                    </div>

                    <div class="inventory-row clickable-stat"
                         t-att-class="{ 'active-filter': state.activeFilter === 'hold' }" 
                         t-on-click.stop="() => this.handleFilterClick('hold')"
                         title="Filtrar apartados en almacén">
                        <span class="inventory-label">On Hold</span>
                        <span class="inventory-value inventory-units" t-esc="props.product.hold_plates || 0"></span>
                        <span class="inventory-value inventory-measure">
                            <t t-esc="props.formatNumber(props.product.hold_qty)"/> <t t-esc="unitLabel"/>
                        </span>
                    </div>

                    <div class="inventory-row clickable-stat"
                         t-att-class="{ 'active-filter': state.activeFilter === 'committed' }" 
                         t-on-click.stop="() => this.handleFilterClick('committed')"
                         title="Filtrar comprometido en almacén">
                        <span class="inventory-label">Committed</span>
                        <span class="inventory-value inventory-units" t-esc="props.product.committed_plates || 0"></span>
                        <span class="inventory-value inventory-measure">
                            <t t-esc="props.formatNumber(props.product.committed_qty)"/> <t t-esc="unitLabel"/>
                        </span>
                    </div>

                    <div class="inventory-row clickable-stat"
                         t-att-class="{ 'active-filter': state.activeFilter === 'available' }" 
                         t-on-click.stop="() => this.handleFilterClick('available')"
                         title="Filtrar disponible para venta en almacén">
                        <span class="inventory-label text-success">Disponible</span>
                        <span class="inventory-value inventory-units" t-esc="props.product.available_plates || 0"></span>
                        <span class="inventory-value inventory-measure text-success">
                            <t t-esc="props.formatNumber(props.product.available_qty)"/> <t t-esc="unitLabel"/>
                        </span>
                    </div>

                    <t t-if="props.product.transit_qty > 0">
                        <div class="inventory-separator">
                            <span>En Tránsito</span>
                        </div>

                        <div class="inventory-row clickable-stat transit-row"
                             t-att-class="{ 'active-filter': state.activeFilter === 'transit_available' }" 
                             t-on-click.stop="() => this.handleFilterClick('transit_available')"
                             title="Disponible en Tránsito">
                            <span class="inventory-label">T. Available</span>
                            <span class="inventory-value inventory-units" t-esc="props.product.transit_available_plates || 0"></span>
                            <span class="inventory-value inventory-measure">
                                <t t-esc="props.formatNumber(props.product.transit_available_qty)"/> <t t-esc="unitLabel"/>
                            </span>
                        </div>

                        <div class="inventory-row clickable-stat transit-row"
                             t-att-class="{ 'active-filter': state.activeFilter === 'transit_hold' }" 
                             t-on-click.stop="() => this.handleFilterClick('transit_hold')"
                             title="Apartado en Tránsito">
                            <span class="inventory-label">T. On Hold</span>
                            <span class="inventory-value inventory-units" t-esc="props.product.transit_hold_plates || 0"></span>
                            <span class="inventory-value inventory-measure">
                                <t t-esc="props.formatNumber(props.product.transit_hold_qty)"/> <t t-esc="unitLabel"/>
                            </span>
                        </div>

                        <div class="inventory-row clickable-stat transit-row"
                             t-att-class="{ 'active-filter': state.activeFilter === 'transit_committed' }" 
                             t-on-click.stop="() => this.handleFilterClick('transit_committed')"
                             title="Comprometido en Tránsito">
                            <span class="inventory-label">T. Committed</span>
                            <span class="inventory-value inventory-units" t-esc="props.product.transit_committed_plates || 0"></span>
                            <span class="inventory-value inventory-measure">
                                <t t-esc="props.formatNumber(props.product.transit_committed_qty)"/> <t t-esc="unitLabel"/>
                            </span>
                        </div>
                    </t>

                </div>
            </td>
            
            <!-- Type -->
            <td class="col-type">
                <span t-if="props.product.tipo" t-esc="props.product.tipo"/>
                <span t-else="" class="text-muted">-</span>
            </td>
            
            <!-- Category -->
            <td class="col-category">
                <span t-if="props.product.categ_name" t-esc="shortCategoryName"/>
                <span t-else="" class="text-muted">-</span>
            </td>
        </tr>
        
        <!-- Fila de detalles -->
        <tr class="o_inventory_details_row" t-if="props.isExpanded">
            <td colspan="4" class="details-cell">
                <ProductDetails 
                    details="filteredDetails"
                    onPhotoClick="props.onPhotoClick"
                    onNotesClick="props.onNotesClick"
                    onDetailsClick="props.onDetailsClick"
                    onSalesPersonClick="props.onSalesPersonClick"
                    onHoldClick="props.onHoldClick"
                    onSaleOrderClick="props.onSaleOrderClick"
                    formatNumber="props.formatNumber"
                    isInCart="props.isInCart"
                    
                    getDisplayQuantity="props.getDisplayQuantity"
                    toggleCartSelection="props.toggleCartSelection"
                    onInputManualQuantity="props.onInputManualQuantity"
                    
                    areAllCurrentProductSelected="props.areAllCurrentProductSelected"
                    selectAllCurrentProduct="props.selectAllCurrentProduct"
                    deselectAllCurrentProduct="props.deselectAllCurrentProduct"
                    hasSalesPermissions="props.hasSalesPermissions"
                    hasInventoryPermissions="props.hasInventoryPermissions"
                />
            </td>
        </tr>
    </t>
    
</templates>